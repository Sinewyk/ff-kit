var Gettext = require("node-gettext");
var gt = new Gettext();
var fs = require('fs');
var path = require('path');

var languages = require('./languages');
//dynamic require => all need to share the same moment
var moment = require('' + 'moment');

languages.forEach(function(_language) {
    var filePath = path.resolve(process.cwd(), 'lang', _language + '.mo');
    var fileContents = fs.readFileSync(filePath);
    gt.addTextdomain(_language, fileContents);
    require('moment/locale/' + _language);
});

//wrapping for replacement
var oldNgettext = gt.ngettext;

//fucking hack, didn't know gettext by itself didn't do interpolation :o
//@todo, keep po/mo stuff, but replace gettext by something more powerful
//jed ? http://slexaxton.github.io/Jed/
gt.ngettext = function(single, plural, count) {
    return oldNgettext.call(gt, single, plural, count).replace('%d', count);
}

gt.moment = moment;

module.exports = gt;
