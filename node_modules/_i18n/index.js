var Jed = require('jed');
var jedGettextParser = require('jed-gettext-parser');
var fs = require('fs');
var path = require('path');

var jed = new Jed({
    domain: "messages"
});
var i18nData = {};

//jedGettextParser wants an ArrayBuffer
//node reads as Buffer
function toArrayBuffer(buffer) {
    var ab = new ArrayBuffer(buffer.length);
    var view = new Uint8Array(ab);
    for (var i = 0; i < buffer.length; ++i) {
        view[i] = buffer[i];
    }
    return ab;
}

var languages = require('./languages');
//dynamic require => all need to share the same moment
var moment = require('' + 'moment');

//@todo
languages.forEach(function(_language) {
    var filePath = path.resolve(process.cwd(), 'lang', _language + '.mo');
    var fileContents = fs.readFileSync(filePath);
    i18nData[_language] = jedGettextParser.mo.parse(toArrayBuffer(fileContents));
    require('moment/locale/' + _language);
});

function changeLanguage(_language) {
    moment.locale(_language);
    jed.options.locale_data = i18nData[_language];
}

module.exports = {
    t: jed,
    moment: moment,
    changeLanguage: changeLanguage
}
