var Reflux = require('reflux');
var Actions = require('_actions');
var ffService = require('_services/fanfiction');
var t = require('_i18n').t;

//@todo factorize all the internal state ...
var storyStore = Reflux.createStore({
    init: function() {
        this.lastInput = null;
        this.fetching = false;
        this.story = {};
        this.lastError = '';
        this.listenTo(Actions.downloadStory, this.downloadStory);
    },
    downloadStory: function(_url) {
        this.lastInput = _url;
        this.lastError = '';
        this.fetching = true;
        this.trigger('fetching');
        ffService.check(_url).bind(this).then(function(story) {
            console.log(story);
            this.story = story;
            this.fetching = true;
            this.lastError = '';
            this.trigger('success');
        }).then(function() {
            return ffService.download(this.story);
        }).then(function(data) {
            this.lastError = t.gettext('Successfully saved the story !');
            this.fetching = false;
            this.trigger('success');
        }).catch(function(e) {
            this.story = {};
            this.fetching = false;
            this.lastError = e.message;
            this.trigger('error');
        });
    },
    getStatus: function() {
        return {
            fetching: this.fetching,
            error: this.lastError,
            input: this.lastInput,
            story: this.story
        };
    }
});

module.exports = storyStore;
